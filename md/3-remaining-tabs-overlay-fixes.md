# ScanPang 구현 3차 — 나머지 탭 + LIVE 투시 오버레이 + 홈 화면 수정

2차에서 바텀시트 기본 + 개요/X레이 탭이 완성된 상태.
이번 작업: 맛집/부동산/관광 탭 추가 + LIVE 투시 AR 오버레이 + 홈 화면 버그 수정.

---

## STEP 1: 맛집 탭 (🍽️)

meta.hasRestaurants === true일 때 탭 표시.

```
레이아웃:

🍽️ 맛집 · 카페

┌─────────────────────────────────────┐
│ ☕  어니언 카페           [즉각 입장] │
│     베이커리 카페                    │
│     대표: 팡도르 5.0                 │
├─────────────────────────────────────┤
│ 🍲  소문난 감자탕          [대기 12팀] │
│     한식당                          │
│     대표: 감자탕(중) 30.0            │
├─────────────────────────────────────┤
│ 🍸  재즈 라운지           [즉각 입장] │
│     요리주점                        │
│     대표: 칵테일 15.0               │
└─────────────────────────────────────┘
```

각 카드:
- 좌: 카테고리 아이콘 (40x40, borderRadius 10, bg rgba(255,255,255,0.08))
- 중:
  - 상호명: fontSize 14, fontWeight 600, color #fff
  - 세부카테고리: fontSize 11, color rgba(255,255,255,0.5)
  - 대표메뉴: fontSize 12, color rgba(255,255,255,0.6), 배경 rgba(255,255,255,0.04), inline pill
- 우: 대기 상태 배지
  - wait_teams === 0 또는 null: "즉각 입장", bg rgba(34,197,94,0.15), color #22c55e
  - wait_teams > 0: "대기 N팀", bg rgba(239,68,68,0.15), color #ef4444
  - is_open === false: "영업종료", bg rgba(107,114,128,0.15), color #9ca3af

카드 스타일: padding 14, borderRadius 12, bg rgba(255,255,255,0.05), border rgba(255,255,255,0.08), marginBottom 8

데이터 없으면:
"이 건물의 맛집 정보를 아직 수집하지 못했어요" + 🍽️ 큰 아이콘 회색

---

## STEP 2: 부동산 탭 (🏠)

meta.hasRealEstate === true일 때 탭 표시.

```
레이아웃:

🏠 매물 정보

┌─────────────────────────────────────┐
│ [원룸]                   상세보기 > │
│ 월세 45만 / 보증금 300        🏠    │
│ 201호 · 8평 (26.4㎡)              │
├─────────────────────────────────────┤
│ [투룸]                   상세보기 > │
│ 전세 1억 2천                  🏠    │
│ 302호 · 15평 (49.5㎡)             │
└─────────────────────────────────────┘
```

각 카드:
- 상단 좌: 매물유형 배지 (원룸/투룸/오피스/상가)
  - bg rgba(245,158,11,0.2), color #fbbf24, fontSize 11, fontWeight 600
- 가격: fontSize 16, fontWeight 700, color #fff
  - listing_type에 따라:
    - monthly_rent: "월세 {monthly_rent}만 / 보증금 {deposit}"
    - jeonse: "전세 {deposit}" (만원→억 변환)
    - sale: "매매 {sale_price}" (만원→억 변환)
- 상세: "{unit_number} · {size_pyeong}평 ({size_sqm}㎡)", fontSize 12, color rgba(255,255,255,0.5)
- 우측: 썸네일 (56x56, borderRadius 8). thumbnail_url 없으면 🏠 아이콘
- "상세보기 >" 링크: fontSize 12, color #60a5fa

데이터 없으면:
"현재 등록된 매물이 없습니다" + 🏠 큰 아이콘 회색

---

## STEP 3: 관광 탭 (✈️)

meta.hasTourism === true일 때 탭 표시.

```
레이아웃:

┌─────────────────────────────────────┐
│ Myeongdong Cathedral             ♡ │
│ ⭐ 4.8  (1,240 review)             │
│                                    │
│ ┌──────────┬──────────┐            │
│ │  혼잡도   │ 운영시간  │            │
│ │ 👥 여유로움│ 09:00-21:00│           │
│ └──────────┴──────────┘            │
│                                    │
│ 입장료                              │
│ ┌──────────────────────────────┐   │
│ │ 무료 (일부 공연 유료)          │   │
│ └──────────────────────────────┘   │
│                                    │
│ 설명                                │
│ 한국 천주교의 상징이자 심장과도 같은   │
│ 곳으로, 고딕 양식의 아름다운 건축물..  │
│                                    │
│ 층별 안내                           │
│ [B1] 1898 광장  [1F] 대성전/성모동굴 │
│ [2F] 파밀리아채플 [3F] 명동예술극장   │
└─────────────────────────────────────┘
```

구현 사항:
- 영문명: fontSize 11, color rgba(255,255,255,0.5)
- 평점: ⭐ 노란색 + 숫자 fontWeight 700 + (N review) 회색
- 즐겨찾기 ♡: 36x36 원형 버튼, 테두리 rgba(255,255,255,0.2)
- 혼잡도/운영시간: 2열 그리드, 각 셀 padding 10, borderRadius 8, bg rgba(255,255,255,0.04)
  - congestion 색상: empty/comfortable → #22c55e, moderate → #f59e0b, crowded → #ef4444
- 입장료: 둥근 박스 안에 텍스트
- 설명: fontSize 12, lineHeight 1.6, color rgba(255,255,255,0.6)
- 층별 안내: 해당 건물의 floors 데이터에서 2열 그리드로 표시

데이터 없으면:
"관광 정보가 등록되지 않은 건물입니다" + ✈️ 큰 아이콘 회색

---

## STEP 4: LIVE 투시 AR 오버레이

바텀시트 헤더의 "LIVE 투시" 버튼을 눌렀을 때, 카메라 영역 위에 층별 정보를 AR 오버레이로 표시.

### 동작 플로우

```
"LIVE 투시" 버튼 터치:
  1. 바텀시트를 15% (미니)로 축소
  2. 카메라 영역 위에 XRayOverlay 컴포넌트 렌더
  3. 층별 바가 건물 위에 세로로 표시됨

"LIVE 투시" 다시 터치 (토글):
  1. XRayOverlay 닫힘
  2. 바텀시트 50%로 복원
```

### XRayOverlay 컴포넌트

```
파일: src/components/XRayOverlay.js

위치: 카메라 뷰 위에 absolute 배치
영역: 화면 상단 절반 ~ 상단 80% 정도

각 층 바:
  - 배경: rgba(20, 20, 50, 0.75)
  - backdropFilter 대신 반투명 배경으로 처리 (RN에서는 투명도로)
  - borderRadius 6
  - padding 8x12
  - 좌: 층 번호 배지 (색상 동일)
  - 중: 테넌트명
  - 우: 아이콘들 + ">" 화살표
  - 간격: gap 3
  - 하이라이트 층: 노란 배경 + 글로우 효과

스크롤:
  - 층이 많으면 ScrollView로 스크롤 가능
  - 우측에 세로 스크롤 인디케이터 (얇은 흰 라인)

애니메이션:
  - 열릴 때: 위에서 아래로 stagger 등장 (각 층 바가 순차적으로 fade in + slide down)
  - 닫힐 때: 아래에서 위로 순차 사라짐
  - Reanimated의 FadeIn, SlideInUp 사용
```

---

## STEP 5: 홈 화면 버그 수정

### 5-1. "주변 건물" 로딩 실패

- **현상**: "주변에 건물 정보가 없습니다 / 다시 시도" 반복. AR에서는 28개 감지되는데 홈에서는 안 나옴.
- **원인**: 홈 화면 API와 AR 건물 감지가 별도 로직.
- **수정**:
  - GPS 위치 확보 완료를 보장한 후 API 호출 (현재는 위치 확보 전에 호출하는 듯)
  - AR에서 캐시한 건물 데이터를 Context 또는 AsyncStorage에 저장
  - 홈 화면에서 API 실패 시 캐시 데이터 사용
  - API 실패 시 자동 재시도 1회
  - 재시도도 실패하면 에러 메시지 + 수동 재시도 버튼 (현재와 동일하지만, 자동 재시도가 먼저)

### 5-2. 최근 활동 건물명 잘림

- **현상**: "이매로143번길 4..." 도로명 주소만 잘려서 표시.
- **수정**:
  - 건물명 표시 우선순위: ① buildings.name ② OSM name 태그 ③ 주소
  - 주소인 경우 numberOfLines={2} + ellipsizeMode="tail"로 2줄까지 표시
  - 스캔 완료 시 건물명을 behavioral_events에 같이 저장해서 최근 활동에서 사용

### 5-3. "을(를)" 조사 처리

- **현상**: "C동을(를) 스캔하고 있어요"
- **수정**: 한국어 받침 판별 유틸 함수 추가

```javascript
// utils/korean.js
function getParticle(word, withBatchim, withoutBatchim) {
  const lastChar = word.charCodeAt(word.length - 1);
  // 한글 범위 체크
  if (lastChar < 0xAC00 || lastChar > 0xD7A3) return withoutBatchim;
  const hasBatchim = (lastChar - 0xAC00) % 28 !== 0;
  return hasBatchim ? withBatchim : withoutBatchim;
}

// 사용: `${name}${getParticle(name, '을', '를')} 스캔하고 있어요`
// "C동을 스캔하고 있어요" (C는 한글이 아니므로 → 받침 없음 → "를"? 
// → 영문/숫자는 마지막 발음 기준 예외 처리 필요. 간단하게 "을(를)" 대신 "스캔 중" 으로 바꿔도 됨)

// 더 간단한 대안: "${name} 스캔 중..." 으로 통일
```

---

## STEP 6: 캡처 버튼 정리

- **현상**: AR 스캔 모드 하단에 캡처 버튼(○)이 있음. 스캔에서는 불필요.
- **수정**: AR 스캔 모드에서 캡처 버튼 숨기기. (바텀시트가 올라오면 자연스럽게 가려지지만, 바텀시트 없을 때도 숨겨야 함)

---

## 완료 확인 (전체 플로우)

### AR 스캔 플로우
- [ ] 앱 시작 → 홈 화면에 주변 건물 카드가 표시됨
- [ ] "스캔 시작" → AR 카메라 + 포커스 가이드 표시
- [ ] 건물 방향으로 카메라 → 포커스 가이드 안에 1개 건물 라벨 + 핀
- [ ] 3초간 비추기 → 게이지 100% → 햅틱 → 바텀시트 자동 열림
- [ ] 바텀시트: 다크 테마, 개요 탭에 편의시설+스탯+피드
- [ ] X레이 탭: 층별 리스트 (색상 배지)
- [ ] 맛집 탭: 음식점 카드 + 대기 상태
- [ ] 부동산 탭: 매물 카드
- [ ] 관광 탭: 평점+혼잡도+운영시간
- [ ] "LIVE 투시" → 카메라 위에 층별 AR 오버레이
- [ ] X 닫기 → AR 스캔 복귀, 게이지 리셋

### 라벨 터치 플로우
- [ ] 라벨/핀 터치 → 바텀시트 즉시 열림 (게이지 무시)
- [ ] 동일한 바텀시트 내용

### 데이터 없는 건물
- [ ] 개요 탭만 표시, 스탯은 '-'
- [ ] "이 건물의 정보를 수집하고 있어요" 안내
- [ ] 다른 탭 숨겨짐

### 홈 화면
- [ ] 주변 건물 카드가 로딩됨 (에러 시 재시도 후 캐시 사용)
- [ ] 최근 활동에 건물명이 제대로 표시됨
- [ ] 조사 처리: "C동 스캔 중..." 또는 올바른 조사
