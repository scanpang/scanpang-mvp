# ScanPang 구현 2차 — 바텀시트 UI + 개요/X레이 탭 + 트리거 연결

1차에서 만든 DB와 API가 준비된 상태.
이번 작업: BuildingProfileSheet 컴포넌트 구현 + 게이지/터치 트리거 연결.

---

## STEP 1: 바텀시트 트리거 연결

### 1-1. 게이지 완료 시 (기존 코드 수정)

현재 게이지 100% 도달하면 "C동 스캔 완료!" 텍스트만 뜨고 끝남. 이걸 수정:

```
게이지 100% 도달 시:
  1. Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Medium) — 햅틱 피드백
  2. "스캔 완료!" 텍스트 0.5초만 표시 후 자동 소멸 (현재 5초+ → 0.5초로 단축)
  3. POST /api/buildings/:id/scan-complete 호출
  4. 응답 받으면 → BuildingProfileSheet 열기 (snap to index 1 = 50%)
  5. 스캔 완료 후에도 라벨은 유지 (현재 버그: 라벨이 사라짐 → 수정)
```

### 1-2. 라벨/핀 터치 시

```
라벨 카드 또는 핀 아이콘 onPress:
  1. GET /api/buildings/:id/profile 호출
  2. 응답 받으면 → BuildingProfileSheet 즉시 열기 (snap to index 1 = 50%)
  (게이지 무시, 기다릴 필요 없이 즉시 열림)
```

### 1-3. 바텀시트 닫기

```
X 버튼 터치 또는 아래로 스와이프:
  1. 바텀시트 닫힘
  2. AR 스캔 모드로 복귀
  3. 포커스 가이드 + 라벨 다시 활성화
  4. 게이지 리셋
```

### 1-4. 건물 전환 처리

```
바텀시트가 열려있는 상태에서 다른 건물이 포커스에 들어오면:
  → 바텀시트는 유지하되 내용 안 바뀜 (유저가 닫기 전까지)
  → 닫은 후 새 건물 스캔 가능

바텀시트가 닫혀있는 상태에서 새 건물 포커스:
  → 이전 건물의 "스캔 완료" 상태 클리어
  → 새 건물 라벨 + 게이지 시작
```

---

## STEP 2: BuildingProfileSheet 컴포넌트

@gorhom/bottom-sheet 사용. 다크 테마.

### 2-1. 기본 구조

```
파일: src/components/BuildingProfileSheet.js (또는 .tsx)

Props:
  - visible: boolean
  - buildingProfile: object (API 응답 전체)
  - onClose: () => void

사용하는 라이브러리:
  - @gorhom/bottom-sheet (이미 설치되어 있을 것)
  - react-native-reanimated (이미 설치되어 있을 것)

snap points: ['15%', '50%', '90%']
  - 15%: 미니 — 건물명 + 거리만
  - 50%: 중간 — 헤더 + 탭바 + 현재 탭 컨텐츠 (기본)
  - 90%: 풀 — 전체 스크롤 가능

배경색: #141428
핸들 인디케이터: rgba(255,255,255,0.2), width 36, height 4, borderRadius 2
```

### 2-2. 헤더 레이아웃

```
┌──────────────────────────────────────┐
│ ━━━  (드래그 핸들)                    │
│                                      │
│ 역삼 스퀘어              LIVE 투시  X │
│ 📍 내 위치에서 120m                   │
└──────────────────────────────────────┘

- 건물명: fontSize 20, fontWeight 800, color #fff
- 거리: fontSize 12, color rgba(255,255,255,0.5)
- "LIVE 투시" 버튼: 보라색 테두리 pill, 배경 rgba(139,92,246,0.15), 텍스트 #c084fc
- "X" 버튼: 32x32, 원형, 테두리 rgba(255,255,255,0.15)
```

### 2-3. 탭 바

```
[🏢 개요] [👁️ X레이] [🍽️ 맛집] [🏠 부동산] [✈️ 관광]

- 가로 ScrollView
- 각 탭: paddingH 14, paddingV 6, borderRadius 20
- 활성: background rgba(255,255,255,0.15), color #fff, fontWeight 700
- 비활성: background transparent, color rgba(255,255,255,0.5)
- 데이터 없는 탭은 숨김 (meta.hasFloors === false → X레이 탭 안 보임)
- 개요 탭은 항상 표시
```

### 2-4. 개요 탭 (🏢)

```
1. 편의시설 태그 (가로 ScrollView)
┌────────────┐ ┌────────────┐ ┌────────────┐
│ ● ATM      │ │ ● 편의점    │ │ ● 와이파이  │
│ 1F 로비    │ │ 2F 24시간  │ │ 무료       │
└────────────┘ └────────────┘ └────────────┘
- 각 태그: padding 8x12, borderRadius 10, bg rgba(255,255,255,0.07)
- 왼쪽 색상 점 (6x6 원): 초록/파랑/보라/노랑 등
- 데이터 없으면 이 섹션 전체 숨김

2. 스탯 그리드 (4열)
┌────────┬────────┬────────┬────────┐
│  🏢   │  📊   │  🏬   │  🕐   │
│ 총층수 │ 입주율 │ 테넌트 │ 영업중 │
│  12층  │  87%  │  24개  │  18개  │
└────────┴────────┴────────┴────────┘
- 각 셀: textAlign center, padding 12x4, borderRadius 12, bg rgba(255,255,255,0.05)
- 아이콘 fontSize 20, 값 fontSize 16 fontWeight 700
- stats가 null이면 값을 '-'으로 표시

3. LIVE 피드
● 지금 이 순간 [LIVE]
┌─────────────────────────────────────┐
│ ⭐ 4F 카페 오늘의 메뉴 업데이트  방금 │
│    아메리카노 20% 할인               │
├─────────────────────────────────────┤
│ 🏋️ 5F 피트니스 PT 예약 가능    2분전 │
│    오후 슬롯 3자리 남음              │
└─────────────────────────────────────┘
- 섹션 헤더: ● 초록 pulse 점 + "지금 이 순간" + LIVE 빨간 배지
- 각 피드: 아이콘(36x36 원) + 제목/부제 + 시간 배지
- 피드 0개면: "아직 실시간 정보가 없습니다" 회색 텍스트

4. 프로모션 배너 (promotion이 있을 때만)
┌─────────────────────────────────────┐
│ ⭐ 광고 보고 포인트 받기             │
│    500P 적립 가능                    │
│    매장 방문 인증하고 500P 받으세요!  │
│ ┌─────────────────────────────────┐ │
│ │  ▶ 광고 보고 포인트 받기         │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
- 그라디언트 배경: 앰버→빨강 15% opacity
- 테두리: rgba(245,158,11,0.3)
- CTA 버튼: 풀폭, gradient bg, 흰색 볼드 텍스트
```

### 2-5. X레이 탭 (👁️)

```
LIVE 투시 · 층별 정보

┌────────────────────────────────────┐
│ [RF] 옥상정원              🌿 ☀️ > │
│ [12F] SKY라운지              🍷 > │
│ [11F] 스타트업 A사         🏢 👥 > │
│ [10F] 스타트업 B사         🏢 💻 > │
│ [9F] IT 솔루션            💻 📱 > │
│ [8F] 법률사무소            📋 👥 > │
│ [7F] 회계법인 ★           💰 📊 > │  ← 하이라이트 (노란 테두리)
│ [6F] 공실                          │  ← 흐리게 (opacity 0.5)
│ [5F] 피트니스센터            💪 > │
│ [4F] 카페 & 라운지        ☕ 📶 > │
│ [3F] 컨퍼런스룸              🎤 > │
│ [2F] 편의시설                🏪 > │
│ [1F] 로비 & 안내            🏛️ > │
│ [B1] 주차장                  🅿️  │
└────────────────────────────────────┘

각 층 바:
- padding 10x12, borderRadius 8, gap 3
- bg: rgba(255,255,255,0.06), 공실은 rgba(255,255,255,0.02)
- 층 번호 배지: padding 2x6, borderRadius 4, 흰색 텍스트, fontSize 11 fontWeight 700
  배지 색상:
    RF → #ef4444 (빨강)
    10F+ → #a855f7 (보라)
    5F~9F → #3b82f6 (파랑)
    1F~4F → #06b6d4 (시안)
    B1~ → #475569 (회색)
- 테넌트명: fontSize 13, fontWeight 500, color #fff (공실은 rgba(255,255,255,0.4))
- 아이콘: fontSize 12, 우측 정렬
- 하이라이트 층 (has_reward=true): 노란 테두리 border 1px rgba(245,158,11,0.4), 배경 gradient

floors 배열이 비어있으면:
  "층별 정보를 수집하고 있어요\n스캔할수록 정보가 채워집니다!"
  + 스켈레톤 바 5개 (pulse 애니메이션)
```

### 2-6. 데이터 로딩 상태

```
API 호출 중:
  - 바텀시트는 즉시 열리되
  - 내용 영역에 스켈레톤 로딩 표시
  - 헤더는 건물명만 표시 (AR 라벨에서 가져온 정보)

API 실패 시:
  - "데이터를 불러올 수 없습니다. 다시 시도해주세요" + 재시도 버튼

데이터가 거의 없는 건물:
  - 개요 탭만 표시
  - 스탯은 '-'로
  - "이 건물의 정보를 수집하고 있어요" 안내 메시지
```

---

## STEP 3: 기존 버그 동시 수정

바텀시트 연결하면서 같이 고쳐야 하는 것들:

### 3-1. 게이지 완료 후 라벨 사라지는 버그
- 현재: 스캔 완료 → 라벨+핀 사라짐 → 같은 방향 비춰도 안 나타남
- 수정: 스캔 완료 후 라벨 유지. 바텀시트가 올라와도 뒤에 라벨 보임.

### 3-2. "스캔 완료!" 메시지 잔존
- 현재: 5초+ 남아있음
- 수정: 0.5초 후 소멸. 바텀시트가 올라오면서 자연스럽게 대체.

### 3-3. 건물 전환 시 이전 상태 잔상
- 현재: "C동 스캔 완료!" 메시지가 남아있으면서 B동 라벨 동시 표시
- 수정: 새 건물 포커스 시 이전 건물의 완료 상태/메시지 즉시 클리어.

---

## 스타일 가이드 (다크 테마)

```
바텀시트 배경: #141428
카드 배경: rgba(255,255,255,0.05)
카드 테두리: rgba(255,255,255,0.08)
텍스트 1차: #ffffff
텍스트 2차: rgba(255,255,255,0.5)
텍스트 3차: rgba(255,255,255,0.3)

액센트: #f59e0b (앰버)
성공: #22c55e
위험: #ef4444
정보: #3b82f6
보라 (LIVE 투시): #a855f7

탭 활성: bg rgba(255,255,255,0.15) + color #fff
탭 비활성: bg transparent + color rgba(255,255,255,0.5)

카드 borderRadius: 12
배지 borderRadius: 6
탭 borderRadius: 20
```

---

## 완료 확인

- [ ] 게이지 100% → 햅틱 + 바텀시트 자동 열림 (50% snap)
- [ ] 라벨/핀 터치 → 바텀시트 즉시 열림
- [ ] 바텀시트 다크 테마 (#141428 배경)
- [ ] 3단계 snap (15%/50%/90%) 동작
- [ ] 개요 탭: 편의시설 태그 가로 스크롤
- [ ] 개요 탭: 스탯 4열 그리드
- [ ] 개요 탭: LIVE 피드 리스트
- [ ] 개요 탭: 프로모션 배너 (데이터 있을 때)
- [ ] X레이 탭: 층별 리스트 (색상 배지, 아이콘, 공실 흐리게)
- [ ] 데이터 없는 탭은 탭바에서 숨김
- [ ] 데이터 없는 건물: "수집 중" 안내 표시
- [ ] X 버튼 → 바텀시트 닫힘 → AR 복귀
- [ ] 스캔 완료 후 라벨이 사라지지 않음 (버그 수정됨)
- [ ] 완료 메시지 0.5초만 표시 (버그 수정됨)
