# ScanPang AR 스캔 화면 대폭 수정 요청

실제 기기 시연 영상을 확인한 결과, AR 스캔 화면의 UX를 근본적으로 바꿔야 한다.
현재 방식(여러 건물 라벨이 동시에 떠다님)을 폐기하고, **포커스 가이드 기반 1건물 스캔 방식**으로 전환한다.

---

## PART 1: 현재 버그 수정

### 1-1. 홈 화면 "주변 건물" 로딩 실패
- **현상**: "주변에 건물 정보가 없습니다 / 다시 시도" 또는 스켈레톤만 계속 표시됨. 두 번째 진입 때는 A동, B동 카드가 로딩됐는데 첫 진입은 실패.
- **원인 추정**: 앱 시작 시 GPS 위치 확보 전에 API를 호출해서 빈 결과가 오거나, OSM Overpass API 타임아웃.
- **수정**: GPS 위치 확보 완료 후 주변 건물 API 호출하도록 순서 보장. 로딩 중에는 스켈레톤 표시하되, 실패 시 자동 재시도 1회 + 에러 메시지 표시.

### 1-2. AR 스캔 진입 시 "위치를 탐색하고 있습니다..." 로딩이 너무 오래 걸림
- **현상**: 카메라는 켜지는데 "위치를 탐색하고 있습니다..." 메시지가 5초 이상 표시되고, 그 동안 건물 라벨이 하나도 안 뜸. 두 번째 진입에도 동일.
- **수정**: GPS 캐시 활용 (홈 화면에서 이미 위치를 잡았으므로 그 좌표를 재사용). 건물 데이터 프리페치. 로딩 상태에서도 이전 캐시된 건물 데이터로 먼저 라벨 표시.

### 1-3. 건물 이름이 "이매로133번...", "이매로143번..." 등 주소로만 표시됨
- **현상**: 의미있는 건물명 대신 도로명 주소만 잘려서 표시됨. 아파트 단지명이 없음.
- **수정**: 
  - OSM에서 `name` 태그 우선 사용
  - name 없으면 `addr:street` + `addr:housenumber` 전체 표시 (잘리지 않게)
  - 아파트인 경우 상위 relation의 name 가져오기 (예: "이매촌한신 A동")
  - building 타입 매핑: apartment→아파트, commercial→상업빌딩, retail→상가

### 1-4. Flywheel Dashboard 데이터 전부 0
- **현상**: 여러 번 스캔했는데 총 소싱 0, 검증률 0%, 커버리지 0개.
- **수정**: Gemini Vision 분석 → 자동 소싱 → DB 저장 파이프라인이 실제로 연결되어 동작하는지 확인하고 수정.

---

## PART 2: AR 스캔 UX 대폭 변경 — 포커스 가이드 방식

현재 방식의 문제:
- 여러 라벨이 동시에 떠서 겹침
- 유저가 어떤 건물을 보고 있는지 불명확
- 건물 선택/상호작용 흐름이 없음

### 새로운 AR 스캔 플로우:

```
[카메라 전체화면]
     ┌─────────────────────────┐
     │  ← 일반 모드  ★1,200  GPS│  ← 상단 HUD (유지)
     │                         │
     │                         │
     │    ┌───────────────┐    │
     │    │               │    │
     │    │  포커스 가이드  │    │  ← 화면 중앙에 반투명 사각형 가이드
     │    │   영역         │    │     (모서리만 둥근 코너 라인으로 표시)
     │    │               │    │
     │    └───────────────┘    │
     │                         │
     │   ┌──────────────────┐  │
     │   │ 🏢 역삼 스퀘어    │  │  ← 포커스 영역에 들어온 건물 1개만
     │   │ 복합 문화 공간    │  │     라벨 + 핀 표시
     │   │ 📍 150m    72%  │  │
     │   │ ████████░░ ←게이지│  │  ← 비추고 있으면 게이지 차오름
     │   └──────────────────┘  │
     │                         │
     │  건물에 카메라를 맞춰주세요  │  ← 하단 안내 텍스트
     └─────────────────────────┘
```

### 2-1. 포커스 가이드 영역 추가
- 화면 중앙에 **반투명 사각형 포커스 가이드** 표시
- 스타일: 모서리 4개만 흰색/밝은색 코너 라인 (카메라 스캔 느낌, QR 스캐너 스타일)
- 포커스 영역 바깥은 살짝 어둡게 오버레이 (dimming, opacity 0.3 정도)
- 가이드 아래에 안내 텍스트: "건물에 카메라를 맞춰주세요"
- 건물이 포커스 영역에 들어오면 안내 텍스트 변경: "역삼 스퀘어를 스캔하고 있어요"

### 2-2. 포커스 영역 안의 건물 1개만 라벨 표시
- **기존의 여러 라벨 동시 표시 방식 제거**
- 포커스 영역(화면 중앙 영역)의 방위각 범위에 해당하는 건물 중 **가장 가까운 1개만** 라벨 + 핀 표시
- 라벨 카드 디자인:
  - 건물명 (볼드)
  - 건물 타입 (서브텍스트)
  - 거리 + confidence %
  - **스캔 게이지 바** (아래쪽에 프로그레스 바)
- 핀: 라벨 아래에 위치 핀 아이콘 (현재 회색 동그라미 → 레퍼런스처럼 주황색 로케이션 핀으로 변경)

### 2-3. 게이지 시스템 (Gaze 스캔)
- 포커스 영역에 건물 라벨이 표시된 상태에서 **유저가 그대로 비추고 있으면** 게이지가 차오름
- 게이지 충전 시간: **3초** (0% → 100%)
- 게이지 바 디자인: 라벨 카드 하단에 얇은 프로그레스 바 (주황색 → 초록색으로 채워짐)
- 유저가 다른 방향으로 돌리면 게이지 리셋 (또는 점진적 감소)
- 게이지가 100% 차면:
  1. 햅틱 피드백 (짧은 진동)
  2. 성공 효과음/애니메이션 (체크마크 ✓ 또는 초록 테두리 플래시)
  3. **자동으로 건물 프로필 바텀시트 올라옴**

### 2-4. 라벨/핀 터치로도 건물 프로필 열기
- 게이지를 기다리지 않고, 라벨 카드나 핀을 **터치하면 즉시** 건물 프로필 바텀시트 열림
- 두 가지 진입 경로:
  - 경로 A: 비추고 있으면 게이지 → 자동 열림 (hands-free)
  - 경로 B: 라벨/핀 터치 → 즉시 열림 (빠른 접근)

### 2-5. 건물 프로필 바텀시트 (레퍼런스 영상 참고)
- 세번째 레퍼런스 영상의 UI를 참고해서 다크 테마 바텀시트 구현:

```
┌──────────────────────────────────┐
│ ━━━  (드래그 핸들)                │
│                                  │
│ 역삼 스퀘어              LIVE 투시  X │
│ 📍 내 위치에서 120m               │
│                                  │
│ [ATM]  [편의점]  [와이파이]  [냉난방] │  ← 편의시설 태그 (가로 스크롤)
│ 1F로비  2F 24시간  무료    중앙공급  │
│                                  │
│  🏢       ⏱       🏬      🕐    │
│ 총 층수   입주율   테넌트   영업중  │  ← 건물 스탯
│  12층    87%     24개    18개   │
│                                  │
│ ● 지금 이 순간 LIVE               │
│ ┌────────────────────────────┐  │
│ │ ⭐ 4F 카페 오늘의 메뉴 업데이트 │  │  ← 실시간 피드
│ │   아메리카노 20% 할인     방금 │  │
│ └────────────────────────────┘  │
│                                  │
│ ── 층별 정보 (LIVE 투시) ──       │
│ RF │ 옥상정원          🌿 ☀️    │  ← 층별 리스트
│ 12F│ SKY라운지          🍷      │     (레퍼런스처럼 반투명 바 스타일)
│ 11F│ 스타트업 A사       🏢 👥    │
│ 10F│ 스타트업 B사       🏢 💻    │
│ 9F │ IT 솔루션         💻 📱    │
│ 8F │ 법률사무소         📋 👥    │
│ 7F │ 회계법인          💰 📊    │  ← 하이라이트 (선택된 층)
│ 6F │ 공실                       │
│ 5F │ 피트니스센터       💪       │
│ 4F │ 카페 & 라운지     ☕       │
│ 3F │ 컨퍼런스룸        🎤       │
│ 2F │ 편의시설          🏪       │
│ 1F │ 로비 & 안내       🏛️       │
└──────────────────────────────────┘
```

- 바텀시트 snap point 3단계: 미니(건물명+태그만) / 중간(스탯+피드) / 풀(층별 정보)
- 다크 테마 (배경 #1a1a2e ~ #16213e 계열)
- 층별 리스트: 반투명 바 스타일, 각 층에 아이콘 + 테넌트명
- "LIVE 투시" 버튼 누르면 층별 리스트가 카메라 위에 AR 오버레이로도 표시 (레퍼런스 영상처럼)
- X 버튼으로 바텀시트 닫기 → AR 스캔 화면으로 복귀

---

## PART 3: 추가 수정사항

### 3-1. "+N개 건물" 클러스터 배지 제거
- 기존에 화면에 "+10개 건물", "+14개 건물" 배지가 떴는데, 새로운 포커스 방식에서는 불필요.
- 대신 포커스 가이드 상단에 작게 "주변 N개 건물 감지" 텍스트만 표시.

### 3-2. 상단 HUD 개선
- "● 스캔" → "● 일반 모드" (레퍼런스 참고)
- "● 위치 확인중..." → GPS 확보되면 즉시 "● GPS 활성" 으로 전환
- "7-Factor 79" 수치는 유지하되, 포커스된 건물의 confidence가 더 직관적이므로 7-Factor는 작게 표시

### 3-3. 하단 캡처 버튼
- 현재 카메라 하단 중앙에 캡처 버튼 (○)이 있는데, AR 스캔에서는 불필요.
- 캡처 버튼 제거하거나, 스캔 모드에서는 숨기기.

---

## 구현 우선순위

1순위: PART 2-1 ~ 2-4 (포커스 가이드 + 1건물 라벨 + 게이지 + 터치 열기)
2순위: PART 2-5 (건물 프로필 바텀시트)
3순위: PART 1 (기존 버그 수정)
4순위: PART 3 (추가 개선)

## 수정 후 확인 체크리스트

- [ ] AR 화면에 포커스 가이드 사각형이 중앙에 보이는지
- [ ] 포커스 영역 방향의 가장 가까운 건물 1개만 라벨이 뜨는지
- [ ] 3초간 비추면 게이지가 차고 바텀시트가 자동으로 올라오는지
- [ ] 라벨/핀 터치하면 바텀시트가 즉시 올라오는지
- [ ] 바텀시트에 건물명, 편의시설, 스탯, 층별 정보가 표시되는지
- [ ] 바텀시트 닫으면 AR 스캔으로 복귀하는지
- [ ] 다른 건물 방향으로 돌리면 라벨이 새 건물로 바뀌는지
